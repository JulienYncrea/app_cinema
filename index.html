<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CineBook üå∏</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#FFC0CB" /> <style>
    body {
      font-family: 'Arial', sans-serif; /* Police claire */
      margin: 0; padding: 1.5rem; /* Un peu plus d'espace */
      background: #F8F0F7; /* Rose tr√®s p√¢le, presque blanc */
      color: #333333; /* Texte sombre pour un bon contraste */
    }
    h1, h2 {
      text-align: center;
      color: #D81B60; /* Rose vif */
      font-weight: bold;
      margin-bottom: 1.5rem;
    }
    /* Style pour le titre principal et le logo cliquable */
    #mainTitle {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem; /* Plus d'espace entre le texte et le logo */
      color: #D81B60;
      cursor: pointer;
      font-size: 2.2rem; /* Plus grand pour le titre */
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1); /* L√©g√®re ombre pour le relief */
    }
    #mainTitle .logo {
        margin-left: 0.75rem;
        font-size: 1.5em; /* Taille du logo (emoji) */
    }

    form, .film-list, .controls, .director-ranking-container {
      max-width: 600px;
      margin: 1.5rem auto; /* Plus d'espace autour des blocs */
      background: #FFFFFF; /* Fond blanc pur pour les blocs principaux */
      padding: 1.5rem;
      border-radius: 1rem; /* Bords plus arrondis */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Ombre douce */
    }
    label {
      display: block;
      margin-top: 1rem; /* Plus d'espace au-dessus des labels */
      font-weight: bold;
      color: #6A1B9A; /* Violet doux pour les labels */
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.75rem; /* Plus de padding */
      margin-top: 0.4rem;
      border: 1px solid #E0BBE4; /* Bordure douce */
      border-radius: 0.5rem; /* Bords arrondis */
      box-sizing: border-box;
      background-color: #F8F8F8; /* Fond l√©g√®rement gris√© pour les inputs */
      color: #333333;
    }
    input:focus, select:focus, textarea:focus {
        border-color: #FF8AD8; /* Bordure rose au focus */
        outline: none;
        box-shadow: 0 0 5px rgba(255, 138, 216, 0.5); /* Ombre l√©g√®re au focus */
    }

    button {
      margin-top: 1.5rem;
      background: #FF69B4; /* Rose bonbon */
      color: #FFFFFF;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-size: 1.1rem; /* Texte du bouton un peu plus grand */
      border: none; /* Pas de bordure sur les boutons */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background: #E55B9F; /* Rose plus fonc√© au survol */
      transform: translateY(-2px); /* L√©ger effet de soul√®vement */
    }
    .film {
      background: #FFF0F5; /* Rose p√¢le pour les films */
      padding: 0.75rem 1.25rem; /* Plus de padding */
      margin-top: 0.8rem; /* Plus d'espace entre les films */
      border-radius: 0.8rem; /* Bords plus arrondis */
      cursor: pointer;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* Ombre tr√®s l√©g√®re */
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .film:hover {
      background: #FFC0CB; /* Rose plus marqu√© au survol */
      transform: translateY(-2px);
    }
    .film-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    .film-title {
      font-weight: bold;
      font-size: 1.2rem; /* Titre du film plus grand */
      flex-grow: 1;
      color: #6A1B9A; /* Violet pour les titres de films */
    }
    .film-director {
      font-size: 0.95rem;
      color: #888888; /* Gris doux */
      margin-top: 0.2rem;
    }
    .film-date, .film-average {
      font-size: 0.95rem;
      color: #888888;
      white-space: nowrap;
      margin-left: 0.8rem;
    }
    .film-details {
      margin-top: 0.8rem;
      background: #FFDDEE; /* Rose l√©ger pour les d√©tails ouverts */
      padding: 0.8rem;
      border-radius: 0.8rem;
      color: #333333;
      display: none;
      font-size: 0.95rem;
      border: 1px solid #F3CCE5; /* Bordure douce */
    }
    .film-details p {
      margin: 0.3rem 0;
    }
    textarea {
      resize: vertical;
      min-height: 80px; /* Hauteur min un peu plus grande */
    }
    .controls {
      display: flex;
      justify-content: flex-end;
      gap: 1.25rem; /* Plus d'espace entre les contr√¥les */
      background: #FDFDFD; /* Fond clair pour les contr√¥les */
      padding: 0.75rem 1.5rem;
      border-radius: 0.8rem;
      margin-bottom: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    select {
      max-width: 200px; /* Un peu plus large si besoin */
    }
    /* Boutons suppression et modification dans d√©tails */
    .btn-action {
      background: #DC143C; /* Cramoisi pour supprimer */
      border: none;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      border-radius: 0.4rem;
      margin-top: 0.8rem;
      user-select: none;
      transition: background-color 0.3s ease;
      margin-right: 0.6rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-action:hover {
      background: #B20D2C;
    }
    .btn-edit {
        background: #9C27B0; /* Violet plus fonc√© pour modifier */
    }
    .btn-edit:hover {
      background: #7B1FA2;
    }

    /* Styles pour le classement des r√©alisateurs */
    .director-ranking-container {
      margin-top: 2.5rem;
      background: #FFFFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    .director-ranking-container h2 {
      margin-top: 0;
      margin-bottom: 1.25rem;
      color: #D81B60;
    }
    .director-ranking-list {
      list-style: none;
      padding: 0;
    }
    .director-ranking-list li {
      background: #FFF0F5; /* Rose p√¢le */
      padding: 0.8rem 1.2rem;
      margin-bottom: 0.6rem;
      border-radius: 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .director-ranking-list li span:first-child {
      font-weight: bold;
      color: #6A1B9A;
    }
    .director-ranking-list li span:last-child {
      color: #D81B60;
      font-weight: bold;
      font-size: 1rem;
    }

    /* Styles pour le s√©lecteur d'√©toiles */
    .star-rating {
      display: inline-block;
      direction: rtl;
      unicode-bidi: bidi-override; /* Permet le RTL */
      margin-top: 0.5rem;
    }
    .star-rating input[type="radio"] {
      display: none;
    }
    .star-rating label {
      font-size: 1.8rem; /* √âtoiles plus grandes */
      color: #CCCCCC; /* Gris clair pour les √©toiles non s√©lectionn√©es */
      cursor: pointer;
      display: inline-block;
      padding: 0 3px; /* Plus d'espace entre les √©toiles */
      transition: color 0.2s ease;
    }
    .star-rating input[type="radio"]:checked ~ label {
      color: #FFD700; /* Or pour les √©toiles s√©lectionn√©es */
    }
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #FFEC8B; /* Jaune p√¢le au survol */
    }

    @media (max-width: 640px) {
      body {
        padding: 1rem;
      }
      form, .film-list, .controls, .director-ranking-container {
        margin: 1rem auto;
        padding: 1rem;
        border-radius: 0.75rem;
      }
      h1 {
        font-size: 1.8rem;
      }
      #mainTitle .logo {
        font-size: 1.2em;
      }
      .film-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .film-date, .film-average {
        margin-left: 0;
      }
      .controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.8rem;
      }
      select {
        max-width: 100%;
      }
      button {
        font-size: 1rem;
        padding: 0.6rem;
      }
      .btn-action {
        padding: 0.3rem 0.5rem;
        font-size: 0.9rem;
      }
      .star-rating label {
        font-size: 1.5rem;
      }
    }
  </style>
  <script>
    const form = document.getElementById('filmForm');
    const filmList = document.getElementById('filmList');
    const triSelect = document.getElementById('tri'); // Pour le tri des films
    const triDirectorSelect = document.getElementById('triDirector'); // Pour le tri des r√©alisateurs
    const addUpdateBtn = document.getElementById('addUpdateBtn');
    const directorList = document.getElementById('directorList');
    const directorRankingList = document.getElementById('directorRankingList');
    const mainTitle = document.getElementById('mainTitle');
    const globalRatingInput = document.getElementById('global');
    const starRatingContainer = document.getElementById('starRatingInput');

    let filmsData = [];

    function generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    starRatingContainer.addEventListener('change', (e) => {
      if (e.target.name === 'rating') {
        globalRatingInput.value = e.target.value;
      }
    });

    function setStarRating(value) {
      const starId = `star${value}`;
      const starRadio = document.getElementById(starId);
      if (starRadio) {
        starRadio.checked = true;
      }
      globalRatingInput.value = value;
    }

    function getUniqueDirectors(films) {
      const directors = new Set();
      films.forEach(film => {
        if (film.director && film.director.trim() !== '') {
          directors.add(film.director.trim());
        }
      });
      return Array.from(directors).sort();
    }

    function updateDirectorDatalist() {
      const uniqueDirectors = getUniqueDirectors(filmsData);
      directorList.innerHTML = '';

      uniqueDirectors.forEach(director => {
        const option = document.createElement('option');
        option.value = director;
        directorList.appendChild(option);
      });
    }

    function moyenne(film) {
      const value = Number(film.global);
      if (isNaN(value) || value < 1) {
        return 0;
      } else if (value > 5) {
        return 5;
      } else {
        return value;
      }
    }

    function displayStars(rating) {
      const numStars = Math.round(rating);
      return '‚≠ê'.repeat(numStars);
    }

    function displayDirectorRanking() {
      const directorScores = {};

      filmsData.forEach(film => {
        if (film.director && film.director.trim() !== '') {
          const directorName = film.director.trim();
          const filmScore = moyenne(film);

          if (!directorScores[directorName]) {
            directorScores[directorName] = { totalScore: 0, filmCount: 0 };
          }
          directorScores[directorName].totalScore += filmScore;
          directorScores[directorName].filmCount++;
        }
      });

      let rankedDirectors = Object.keys(directorScores)
        .map(director => ({
          name: director,
          averageScore: directorScores[director].totalScore / directorScores[director].filmCount,
          filmCount: directorScores[director].filmCount
        }));

      const triDirector = triDirectorSelect.value;
      rankedDirectors.sort((a, b) => {
        if (triDirector === 'avgDesc') {
          return b.averageScore - a.averageScore;
        } else if (triDirector === 'avgAsc') {
          return a.averageScore - b.averageScore;
        } else if (triDirector === 'filmCountDesc') {
          return b.filmCount - a.filmCount;
        } else if (triDirector === 'filmCountAsc') {
          return a.filmCount - b.filmCount;
        }
        return 0;
      });

      directorRankingList.innerHTML = '';

      if (rankedDirectors.length === 0) {
        directorRankingList.innerHTML = '<li>Aucun r√©alisateur √† classer pour le moment.</li>';
        return;
      }

      rankedDirectors.forEach(director => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${director.name}</span> <span>${displayStars(director.averageScore.toFixed(1))} (${director.averageScore.toFixed(1)}/5) - ${director.filmCount} film(s)</span>`;
        directorRankingList.appendChild(li);
      });
    }

    function chargerFilms() {
      filmsData = JSON.parse(localStorage.getItem('cinebook_films')) || [];

      const tri = triSelect.value;
      filmsData.sort((a, b) => {
        if (tri === 'dateDesc') {
          return new Date(b.date || '0000-01-01') - new Date(a.date || '0000-01-01');
        } else if (tri === 'dateAsc') {
          return new Date(a.date || '0000-01-01') - new Date(b.date || '0000-01-01');
        } else if (tri === 'avgDesc') {
          return moyenne(b) - moyenne(a);
        } else if (tri === 'avgAsc') {
          return moyenne(a) - moyenne(b);
        } else if (tri === 'directorAsc') {
          const directorA = a.director ? a.director.toLowerCase() : '';
          const directorB = b.director ? b.director.toLowerCase() : '';
          return directorA.localeCompare(directorB);
        }
      });

      filmList.innerHTML = '';

      filmsData.forEach((film) => {
        const div = document.createElement('div');
        div.className = 'film';
        div.dataset.id = film.id;

        const avgNoteStars = displayStars(moyenne(film));
        const directorDisplay = film.director ? `<div class="film-director">${film.director}</div>` : '';

        div.innerHTML = `
          <div class="film-header">
            <div>
              <div class="film-title">${film.title}</div>
              ${directorDisplay}
            </div>
            <div>
              <span class="film-average">${avgNoteStars}</span>
              <span class="film-date">${formatDate(film.date)}</span>
            </div>
          </div>
          <div class="film-details">
            <p><strong>R√©alisateur :</strong> ${film.director || 'N/A'}</p>
            <p><strong>Note globale :</strong> ${displayStars(film.global)} (${film.global}/5)</p>
            <p><strong>Commentaire :</strong> ${film.commentaire || '(pas de commentaire)'}</p>
            <button class="btn-action btn-edit" data-id="${film.id}" title="Modifier ce film">‚úèÔ∏è Modifier</button>
            <button class="btn-action btn-delete" data-id="${film.id}" title="Supprimer ce film">üóëÔ∏è Supprimer</button>
          </div>
        `;

        const header = div.querySelector('.film-header');
        const details = div.querySelector('.film-details');
        const btnDelete = div.querySelector('.btn-delete');
        const btnEdit = div.querySelector('.btn-edit');

        btnDelete.addEventListener('click', e => {
          e.stopPropagation();
          const filmIdToDelete = e.target.dataset.id;
          if (confirm(`Supprimer "${filmsData.find(f => f.id === filmIdToDelete)?.title}" ?`)) {
            filmsData = filmsData.filter(f => f.id !== filmIdToDelete);
            localStorage.setItem('cinebook_films', JSON.stringify(filmsData));
            chargerFilms();
            updateDirectorDatalist();
            displayDirectorRanking();
          }
        });

        btnEdit.addEventListener('click', e => {
            e.stopPropagation();
            const filmIdToEdit = e.target.dataset.id;
            const filmToEdit = filmsData.find(f => f.id === filmIdToEdit);

            if (filmToEdit) {
                form.title.value = filmToEdit.title;
                form.director.value = filmToEdit.director || '';
                form.date.value = filmToEdit.date;
                // CORRECTION ICI: S'assurer que la note affich√©e pour l'√©dition est bien "capp√©e" √† 5
                let displayRating = Number(filmToEdit.global);
                if (isNaN(displayRating) || displayRating < 1) {
                    displayRating = 0;
                } else if (displayRating > 5) {
                    displayRating = 5; // Capper √† 5 pour le formulaire d'√©dition
                }
                setStarRating(displayRating); // Utiliser la note ajust√©e
                form.commentaire.value = filmToEdit.commentaire;

                addUpdateBtn.textContent = 'Modifier ‚úèÔ∏è';
                form.dataset.editingId = filmIdToEdit;

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        header.addEventListener('click', () => {
          const visible = details.style.display === 'block';

          document.querySelectorAll('.film-details').forEach(d => d.style.display = 'none');

          details.style.display = visible ? 'none' : 'block';
        });

        filmList.appendChild(div);
      });
      updateDirectorDatalist();
      displayDirectorRanking();
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const d = new Date(dateStr);
      const userTimezoneOffset = d.getTimezoneOffset() * 60000;
      const adjustedDate = new Date(d.getTime() + userTimezoneOffset);
      return adjustedDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();

      if (!form.title.value.trim()) {
        return alert('Le titre est requis.');
      }
      if (!globalRatingInput.value || Number(globalRatingInput.value) < 1 || Number(globalRatingInput.value) > 5) {
        return alert('La note globale est obligatoire et doit √™tre comprise entre 1 et 5 √©toiles.');
      }

      const film = {
        title: form.title.value.trim(),
        director: form.director.value.trim(),
        date: form.date.value,
        global: globalRatingInput.value,
        commentaire: form.commentaire.value.trim()
      };

      const editingId = form.dataset.editingId;

      if (editingId) {
        const filmIndex = filmsData.findIndex(f => f.id === editingId);
        if (filmIndex !== -1) {
            filmsData[filmIndex] = { ...filmsData[filmIndex], ...film };
        }
        delete form.dataset.editingId;
        addUpdateBtn.textContent = 'Ajouter üé•';
      } else {
        film.id = generateUniqueId();
        filmsData.push(film);
      }

      localStorage.setItem('cinebook_films', JSON.stringify(filmsData));

      form.reset();
      setStarRating(0);
      chargerFilms();
    });

    triSelect.addEventListener('change', chargerFilms);
    triDirectorSelect.addEventListener('change', displayDirectorRanking);

    mainTitle.addEventListener('click', () => {
      document.getElementById('directorRanking').scrollIntoView({
        behavior: 'smooth'
      });
    });

    window.addEventListener('load', () => {
        chargerFilms();
        updateDirectorDatalist();
        displayDirectorRanking();
        setStarRating(0);
    });
  </script>
</body>
</html>