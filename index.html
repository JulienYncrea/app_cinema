<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CineBook üé¨</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#111827" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 1rem;
      background: #1f2937;
      color: #f9fafb;
    }
    h1, h2 {
      text-align: center;
      color: #fbbf24;
    }
    /* Style pour le titre principal et le logo cliquable */
    #mainTitle {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem; /* Espace entre le texte et le logo */
      color: #fbbf24;
      cursor: pointer; /* Indique que le titre est cliquable */
    }
    #mainTitle .logo {
        margin-left: 0.5rem; /* Espace le logo du texte */
        font-size: 1.2em; /* Taille du logo (emoji) */
    }

    form, .film-list, .controls, .director-ranking-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #374151;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.2rem;
      border: none;
      border-radius: 0.25rem;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      background: #fbbf24;
      color: #1f2937;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #d19e1a;
    }
    .film {
      background: #111827;
      padding: 0.5rem 1rem;
      margin-top: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .film:hover {
      background: #2563eb;
    }
    .film-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    .film-title {
      font-weight: bold;
      font-size: 1.1rem;
      flex-grow: 1;
    }
    .film-director {
      font-size: 0.9rem;
      color: #d1d5db;
      margin-top: 0.2rem;
    }
    .film-date, .film-average {
      font-size: 0.9rem;
      color: #d1d5db;
      white-space: nowrap;
      margin-left: 0.8rem;
    }
    .film-details {
      margin-top: 0.5rem;
      background: #2563eb;
      padding: 0.5rem;
      border-radius: 0.5rem;
      color: #f3f4f6;
      display: none;
      font-size: 0.9rem;
    }
    .film-details p {
      margin: 0.2rem 0;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .controls {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      background: #374151;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-bottom: 0;
    }
    select {
      max-width: 180px;
    }
    /* Boutons suppression et modification dans d√©tails */
    .btn-action {
      background: #ef4444;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      margin-top: 0.5rem;
      user-select: none;
      transition: background-color 0.3s ease;
      margin-right: 0.5rem; /* Ajout pour espacement */
    }
    .btn-action:hover {
      background: #b91c1c;
    }
    .btn-edit {
        background: #3b82f6; /* Bleu pour modifier */
    }
    .btn-edit:hover {
      background: #1d4ed8;
    }

    /* Styles pour le classement des r√©alisateurs */
    .director-ranking-container {
      margin-top: 2rem;
      background: #374151;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .director-ranking-container h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #fbbf24;
    }
    .director-ranking-list {
      list-style: none;
      padding: 0;
    }
    .director-ranking-list li {
      background: #111827;
      padding: 0.7rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .director-ranking-list li span:first-child {
      font-weight: bold;
    }
    .director-ranking-list li span:last-child {
      color: #fbbf24;
      font-weight: bold;
    }

    @media (max-width: 640px) {
      .film-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .film-date, .film-average {
        margin-left: 0;
      }
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      select {
        max-width: 100%;
      }
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker enregistr√©:', reg.scope))
          .catch(err => console.error('Erreur SW:', err));
      });
    }
  </script>
</head>
<body>
  <h1 id="mainTitle">CineBook <span class="logo">üé¨</span></h1>

  <form id="filmForm" autocomplete="off">
    <label for="title">Titre du film *</label>
    <input type="text" id="title" required />

    <label for="director">R√©alisateur</label>
    <input type="text" id="director" list="directorList" placeholder="Ajouter un r√©alisateur ou en choisir un" />
    <datalist id="directorList"></datalist>

    <label for="date">Date de visionnage</label>
    <input type="date" id="date" />

    <label for="global">Note globale (0-10) *</label>
    <input type="number" id="global" min="0" max="10" required />

    <label for="scenario">Sc√©nario (0-10)</label>
    <input type="number" id="scenario" min="0" max="10" />

    <label for="musique">Musique (0-10)</label>
    <input type="number" id="musique" min="0" max="10" />

    <label for="visuel">Visuel (0-10)</label>
    <input type="number" id="visuel" min="0" max="10" />

    <label for="acteur">Acteurs (0-10)</label>
    <input type="number" id="acteur" min="0" max="10" />

    <label for="commentaire">Commentaire</label>
    <textarea id="commentaire" placeholder="Votre avis sur le film..."></textarea>

    <button type="submit" id="addUpdateBtn">Ajouter üé•</button>
  </form>

  <div class="controls">
    <label for="tri">Trier par :</label>
    <select id="tri">
      <option value="dateDesc" selected>Date (du plus r√©cent)</option>
      <option value="dateAsc">Date (du plus ancien)</option>
      <option value="avgDesc">Note moyenne (la plus haute)</option>
      <option value="avgAsc">Note moyenne (la plus basse)</option>
      <option value="directorAsc">R√©alisateur (A-Z)</option>
    </select>
  </div>

  <h2>üéûÔ∏è Films vus</h2>
  <div class="film-list" id="filmList"></div>

  <div class="director-ranking-container" id="directorRanking">
    <h2>üèÜ Classement des R√©alisateurs</h2>
    <ul class="director-ranking-list" id="directorRankingList">
      </ul>
  </div>

  <script>
    const form = document.getElementById('filmForm');
    const filmList = document.getElementById('filmList');
    const triSelect = document.getElementById('tri');
    const addUpdateBtn = document.getElementById('addUpdateBtn');
    const directorList = document.getElementById('directorList');
    const directorRankingList = document.getElementById('directorRankingList'); // Nouvel √©l√©ment pour le classement
    const mainTitle = document.getElementById('mainTitle'); // Titre principal cliquable

    let editingIndex = -1; // Pour savoir si on est en mode modification ou ajout

    // Fonction pour r√©cup√©rer les r√©alisateurs uniques
    function getUniqueDirectors(films) {
      const directors = new Set();
      films.forEach(film => {
        if (film.director && film.director.trim() !== '') {
          directors.add(film.director.trim());
        }
      });
      return Array.from(directors).sort();
    }

    // Fonction pour mettre √† jour la datalist des r√©alisateurs
    function updateDirectorDatalist() {
      let films = JSON.parse(localStorage.getItem('cinebook_films')) || [];
      const uniqueDirectors = getUniqueDirectors(films);
      directorList.innerHTML = ''; // Vide la liste existante

      uniqueDirectors.forEach(director => {
        const option = document.createElement('option');
        option.value = director;
        directorList.appendChild(option);
      });
    }

    // Fonction pour calculer la moyenne d'un film
    function moyenne(film) {
      let totalNotes = 0;
      let compteurNotes = 0;

      const notes = ['global', 'scenario', 'musique', 'visuel', 'acteur'];

      notes.forEach(noteType => {
        const value = Number(film[noteType]);
        // V√©rifie si la valeur est un nombre, n'est pas vide et est dans la plage 0-10
        if (!isNaN(value) && film[noteType] !== '' && value >= 0 && value <= 10) {
          totalNotes += value;
          compteurNotes++;
        }
      });
      
      return compteurNotes > 0 ? totalNotes / compteurNotes : 0;
    }

    // Fonction pour calculer et afficher le classement des r√©alisateurs
    function displayDirectorRanking() {
      let films = JSON.parse(localStorage.getItem('cinebook_films')) || [];
      const directorScores = {}; // { 'R√©alisateur': { totalScore: X, filmCount: Y } }

      films.forEach(film => {
        if (film.director && film.director.trim() !== '') {
          const directorName = film.director.trim();
          const filmScore = moyenne(film);

          if (!directorScores[directorName]) {
            directorScores[directorName] = { totalScore: 0, filmCount: 0 };
          }
          directorScores[directorName].totalScore += filmScore;
          directorScores[directorName].filmCount++;
        }
      });

      const rankedDirectors = Object.keys(directorScores)
        .map(director => ({
          name: director,
          averageScore: directorScores[director].totalScore / directorScores[director].filmCount
        }))
        .sort((a, b) => b.averageScore - a.averageScore); // Trier par moyenne d√©croissante

      directorRankingList.innerHTML = ''; // Vider la liste existante

      if (rankedDirectors.length === 0) {
        directorRankingList.innerHTML = '<li>Aucun r√©alisateur √† classer pour le moment.</li>';
        return;
      }

      rankedDirectors.forEach(director => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${director.name}</span> <span>‚≠ê ${director.averageScore.toFixed(2)}</span>`;
        directorRankingList.appendChild(li);
      });
    }

    // Charge films et trie selon la s√©lection
    function chargerFilms() {
      let films = JSON.parse(localStorage.getItem('cinebook_films')) || [];

      // Trie selon la s√©lection
      const tri = triSelect.value;
      films.sort((a, b) => {
        if (tri === 'dateDesc') {
          return new Date(b.date || '0000-01-01') - new Date(a.date || '0000-01-01');
        } else if (tri === 'dateAsc') {
          return new Date(a.date || '0000-01-01') - new Date(b.date || '0000-01-01');
        } else if (tri === 'avgDesc') {
          return moyenne(b) - moyenne(a);
        } else if (tri === 'avgAsc') {
          return moyenne(a) - moyenne(b);
        } else if (tri === 'directorAsc') {
          const directorA = a.director ? a.director.toLowerCase() : '';
          const directorB = b.director ? b.director.toLowerCase() : '';
          return directorA.localeCompare(directorB);
        }
      });

      filmList.innerHTML = '';

      films.forEach((film, index) => {
        const div = document.createElement('div');
        div.className = 'film';

        const avgNote = moyenne(film).toFixed(2);
        const directorDisplay = film.director ? `<div class="film-director">${film.director}</div>` : '';

        div.innerHTML = `
          <div class="film-header">
            <div>
              <div class="film-title">${film.title}</div>
              ${directorDisplay}
            </div>
            <div>
              <span class="film-average">‚≠ê ${avgNote}</span>
              <span class="film-date">${formatDate(film.date)}</span>
            </div>
          </div>
          <div class="film-details">
            <p><strong>R√©alisateur :</strong> ${film.director || 'N/A'}</p>
            <p><strong>Note globale :</strong> ${film.global !== undefined && film.global !== '' ? film.global + '/10' : 'N/A'}</p>
            <p><strong>Sc√©nario :</strong> ${film.scenario !== undefined && film.scenario !== '' ? film.scenario + '/10' : 'N/A'}</p>
            <p><strong>Musique :</strong> ${film.musique !== undefined && film.musique !== '' ? film.musique + '/10' : 'N/A'}</p>
            <p><strong>Visuel :</strong> ${film.visuel !== undefined && film.visuel !== '' ? film.visuel + '/10' : 'N/A'}</p>
            <p><strong>Acteurs :</strong> ${film.acteur !== undefined && film.acteur !== '' ? film.acteur + '/10' : 'N/A'}</p>
            <p><strong>Commentaire :</strong> ${film.commentaire || '(pas de commentaire)'}</p>
            <button class="btn-action btn-edit" data-index="${index}" title="Modifier ce film">‚úèÔ∏è Modifier</button>
            <button class="btn-action btn-delete" data-index="${index}" title="Supprimer ce film">üóëÔ∏è Supprimer</button>
          </div>
        `;

        const header = div.querySelector('.film-header');
        const details = div.querySelector('.film-details');
        const btnDelete = div.querySelector('.btn-delete');
        const btnEdit = div.querySelector('.btn-edit');

        btnDelete.addEventListener('click', e => {
          e.stopPropagation(); // emp√™cher toggle d√©tails
          const filmIndex = parseInt(e.target.dataset.index);
          let films = JSON.parse(localStorage.getItem('cinebook_films')) || [];
          if (confirm(`Supprimer "${films[filmIndex].title}" ?`)) {
            films.splice(filmIndex, 1);
            localStorage.setItem('cinebook_films', JSON.stringify(films));
            chargerFilms();
            updateDirectorDatalist(); // Mettre √† jour la datalist apr√®s suppression
            displayDirectorRanking(); // Mettre √† jour le classement des r√©alisateurs
          }
        });

        btnEdit.addEventListener('click', e => {
            e.stopPropagation();
            const filmIndex = parseInt(e.target.dataset.index);
            const films = JSON.parse(localStorage.getItem('cinebook_films')) || [];
            const filmToEdit = films[filmIndex];

            // Remplir le formulaire avec les donn√©es du film
            form.title.value = filmToEdit.title;
            form.director.value = filmToEdit.director || ''; // Nouveau champ
            form.date.value = filmToEdit.date;
            form.global.value = filmToEdit.global;
            form.scenario.value = filmToEdit.scenario;
            form.musique.value = filmToEdit.musique;
            form.visuel.value = filmToEdit.visuel;
            form.acteur.value = filmToEdit.acteur;
            form.commentaire.value = filmToEdit.commentaire;

            addUpdateBtn.textContent = 'Modifier ‚úèÔ∏è';
            editingIndex = filmIndex; // Stocker l'index du film en cours de modification

            window.scrollTo({ top: 0, behavior: 'smooth' }); // Remonter en haut de la page
        });

        header.addEventListener('click', () => {
          const visible = details.style.display === 'block';

          // Fermer tous les autres d√©tails
          document.querySelectorAll('.film-details').forEach(d => d.style.display = 'none');

          details.style.display = visible ? 'none' : 'block';
        });

        filmList.appendChild(div);
      });
      updateDirectorDatalist(); // Toujours mettre √† jour la datalist apr√®s avoir charg√©/affich√© les films
      displayDirectorRanking(); // Mettre √† jour le classement des r√©alisateurs apr√®s chargement des films
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const d = new Date(dateStr);
      // Pour √©viter les d√©calages de fuseau horaire qui peuvent affecter la date affich√©e
      const userTimezoneOffset = d.getTimezoneOffset() * 60000;
      const adjustedDate = new Date(d.getTime() + userTimezoneOffset);
      return adjustedDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();

      // Validation pour la note globale (obligatoire)
      if (!form.global.value.trim() || isNaN(Number(form.global.value)) || Number(form.global.value) < 0 || Number(form.global.value) > 10) {
        return alert('La note globale est obligatoire et doit √™tre comprise entre 0 et 10.');
      }
      if (!form.title.value.trim()) return alert('Le titre est requis');


      const film = {
        title: form.title.value.trim(),
        director: form.director.value.trim(), // Ajout du r√©alisateur
        date: form.date.value,
        global: form.global.value,
        scenario: form.scenario.value,
        musique: form.musique.value,
        visuel: form.visuel.value,
        acteur: form.acteur.value,
        commentaire: form.commentaire.value.trim()
      };

      let films = JSON.parse(localStorage.getItem('cinebook_films')) || [];

      if (editingIndex > -1) {
        // Mode modification
        films[editingIndex] = film;
        editingIndex = -1; // R√©initialiser le mode modification
        addUpdateBtn.textContent = 'Ajouter üé•';
      } else {
        // Mode ajout
        films.push(film);
      }

      localStorage.setItem('cinebook_films', JSON.stringify(films));

      form.reset();
      chargerFilms();
    });

    triSelect.addEventListener('change', chargerFilms);

    // Ajout de l'√©couteur d'√©v√©nement pour le clic sur le titre principal
    mainTitle.addEventListener('click', () => {
      document.getElementById('directorRanking').scrollIntoView({
        behavior: 'smooth'
      });
    });

    window.addEventListener('load', () => {
        chargerFilms();
        updateDirectorDatalist(); // Charger la datalist au chargement initial
        displayDirectorRanking(); // Afficher le classement des r√©alisateurs au chargement initial
    });
  </script>
</body>
</html>