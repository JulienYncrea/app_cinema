<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CineBook üé¨</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#111827" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 1rem;
      background: #1f2937;
      color: #f9fafb;
    }
    h1, h2 {
      text-align: center;
      color: #fbbf24;
    }
    #mainTitle {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      color: #fbbf24;
      cursor: pointer;
    }
    #mainTitle .logo {
        margin-left: 0.5rem;
        font-size: 1.2em;
    }

    form, .film-list, .director-ranking-container {
      max-width: 600px;
      margin: 1rem auto;
      background: #374151;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.2rem;
      border: none;
      border-radius: 0.25rem;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      background: #fbbf24;
      color: #1f2937;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #d19e1a;
    }
    .film {
      background: #111827;
      padding: 0.5rem 1rem;
      margin-top: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .film:hover {
      background: #2563eb;
    }
    .film-header {
      display: flex;
      align-items: center; /* Aligner verticalement au centre */
      justify-content: space-between; /* R√©partir l'espace entre les √©l√©ments */
      gap: 1rem; /* Espace entre les √©l√©ments */
    }
    /* L'affiche n'est plus dans le header, mais dans les d√©tails */
    .film-info-main {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Permet aux infos de prendre l'espace restant */
    }
    .film-title {
      font-weight: bold;
      font-size: 1.1rem;
    }
    .film-director {
      font-size: 0.9rem;
      color: #d1d5db;
      margin-top: 0.2rem;
    }
    .film-date {
      font-size: 0.9rem;
      color: #d1d5db;
      white-space: nowrap;
      margin-top: 0.5rem;
    }
    .film-average {
        font-size: 0.9rem;
        color: #fbbf24;
        white-space: nowrap;
        align-self: center; /* Aligne la note verticalement au centre de la ligne */
        margin-left: auto; /* Pousse la note tout √† droite */
        flex-shrink: 0;
    }

    .film-details {
      margin-top: 0.5rem;
      background: #2563eb;
      padding: 0.5rem;
      border-radius: 0.5rem;
      color: #f3f4f6;
      display: none;
      font-size: 0.9rem;
    }
    .film-details p {
      margin: 0.2rem 0;
    }
    /* Style pour l'affiche quand elle est dans les d√©tails */
    .film-details .film-poster {
        width: 90px; /* Taille un peu plus grande dans les d√©tails */
        height: 135px;
        object-fit: cover;
        border-radius: 3px;
        float: left; /* Pour que le texte s'enroule autour */
        margin-right: 1rem;
        margin-bottom: 0.5rem;
    }
    .film-details::after { /* Clearfix pour le float */
        content: "";
        display: table;
        clear: both;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
      gap: 1rem;
      max-width: 600px;
      margin: 1rem auto;
      background: #374151;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-bottom: 0;
    }
    .controls select {
      max-width: 180px;
      width: auto;
      flex-shrink: 0;
    }
    .controls label {
        margin-top: 0;
        display: inline-block;
        flex-shrink: 0;
    }

    .btn-action {
      background: #ef4444;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      margin-top: 0.5rem;
      user-select: none;
      transition: background-color 0.3s ease;
      margin-right: 0.5rem;
    }
    .btn-action:hover {
      background: #b91c1c;
    }
    .btn-edit {
        background: #3b82f6;
    }
    .btn-edit:hover {
      background: #1d4ed8;
    }

    .director-ranking-container {
      margin-top: 2rem;
      background: #374151;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .director-ranking-container h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #fbbf24;
    }
    .director-ranking-list {
      list-style: none;
      padding: 0;
    }
    .director-ranking-list li {
      background: #111827;
      padding: 0.7rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .director-ranking-list li span:first-child {
      font-weight: bold;
    }
    .director-ranking-list li span:last-child {
      color: #fbbf24;
      font-weight: bold;
    }

    .star-rating {
      display: inline-block;
      direction: rtl;
    }
    .star-rating input[type="radio"] {
      display: none;
    }
    .star-rating label {
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
      display: inline-block;
      padding: 0 2px;
    }
    .star-rating input[type="radio"]:checked ~ label {
      color: #fbbf24;
    }
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #fcd34d;
    }

    #filmPosterPreview {
        max-width: 60px; /* L'image sera redimensionn√©e par CSS */
        height: auto;
        margin-left: 10px;
        vertical-align: middle;
        border-radius: 5px;
    }
    #globalSearch {
        max-width: 180px; /* M√™me largeur max que le select pour PC */
        padding: 0.75rem;
        font-size: 1.1rem;
        border-radius: 0.5rem;
        border: 1px solid #4b5563;
        background-color: #1f2937;
        color: #f9fafb;
        box-sizing: border-box;
        margin-left: auto; /* Pousse le champ √† droite dans le conteneur flex */
        margin-top: 0;
    }
    #globalSearch::placeholder {
        color: #9ca3af;
    }

    /* ************************************** */
    /* MODIFICATIONS POUR MOBILE */
    /* ************************************** */
    @media (max-width: 640px) {
      /* Controls (Tri et Recherche Globale) */
      .controls {
        flex-direction: column; /* Empilement vertical */
        align-items: flex-start; /* Alignement √† gauche */
        gap: 0.5rem; /* R√©duire l'espacement */
        padding: 1rem; /* Assurer un padding suffisant */
      }
      .controls label,
      .controls select,
      #globalSearch {
        width: 100%; /* Prend toute la largeur disponible */
        max-width: 100%; /* S'adapte √† 100% */
        margin-left: 0; /* Annule le margin-left: auto */
        margin-top: 0; /* Annule toute marge top */
        box-sizing: border-box; /* S'assurer que padding et border sont inclus */
      }
      /* Ajouter un espacement entre les √©l√©ments empil√©s des controls */
      .controls label + select,
      .controls select + #globalSearch,
      .controls label + #globalSearch {
          margin-top: 0.5rem !important; /* Ajoute un peu de marge entre les √©l√©ments empil√©s */
      }

      /* Affichage du Film (film-header) */
      .film-header {
        flex-direction: row; /* Garde les infos sur la m√™me ligne */
        flex-wrap: nowrap; /* EMP√äCHE le retour √† la ligne pour les √©l√©ments principaux */
        align-items: center; /* Aligner verticalement au centre pour les √©l√©ments principaux */
        justify-content: space-between; /* R√©partir l'espace entre les infos et la note */
      }
      /* L'affiche n'est plus dans le header, donc pas de style ici */
      .film-info-main {
        display: flex; /* Le contenu interne (titre, r√©alisateur, date) reste empil√© */
        flex-direction: column;
        flex-grow: 1; /* Permet aux infos de prendre l'espace restant */
        flex-basis: auto; /* Reviens √† un comportement auto */
        min-width: 0; /* Permet au contenu de r√©tr√©cir si n√©cessaire, sans d√©bordement */
      }
      .film-title {
        font-size: 1rem; /* Ajuster la taille du titre si n√©cessaire */
        white-space: nowrap; /* Emp√™che le titre de passer √† la ligne */
        overflow: hidden; /* Cache le texte qui d√©passe */
        text-overflow: ellipsis; /* Ajoute des points de suspension si le texte est tronqu√© */
      }
      .film-director,
      .film-date {
        font-size: 0.85rem; /* Ajuster la taille des sous-titres */
        margin-top: 0.1rem; /* Rapprocher les lignes de texte */
        white-space: nowrap; /* Emp√™che le texte de passer √† la ligne */
        overflow: hidden; /* Cache le texte qui d√©passe */
        text-overflow: ellipsis; /* Ajoute des points de suspension si le texte est tronqu√© */
      }
      .film-average {
        order: 0; /* Ordre normal */
        margin-left: auto; /* Pousse la note tout √† droite */
        align-self: center; /* Aligne la note verticalement au centre de la ligne */
        width: auto; /* La note reprend sa largeur naturelle */
        text-align: right; /* Aligner le texte √† droite */
        flex-shrink: 0; /* Emp√™che la note de r√©tr√©cir */
        margin-top: 0; /* S'assurer qu'il n'y a pas de marge top ind√©sirable */
        padding-left: 0.5rem; /* Ajoute un petit espace entre le texte et les √©toiles */
      }
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker enregistr√©:', reg.scope))
          .catch(err => console.error('Erreur SW:', err));
      });
    }
  </script>
</head>
<body>
  <h1 id="mainTitle">CineBook <span class="logo">üé¨</span></h1>

  <form id="filmForm" autocomplete="off">
    <label for="titleSearch">Rechercher un film *</label>
    <input type="text" id="titleSearch" placeholder="Taper le titre du film..." list="filmSuggestions" />
    <datalist id="filmSuggestions"></datalist>
    <input type="hidden" id="title" required />
    <input type="hidden" id="posterUrl" />
    <img id="filmPosterPreview" src="" alt="Affiche du film" style="display:none;" />


    <label for="director">R√©alisateur</label>
    <input type="text" id="director" list="directorList" placeholder="Ajouter un r√©alisateur ou en choisir un" />
    <datalist id="directorList"></datalist>

    <label for="date">Date de visionnage *</label>
    <input type="date" id="date" />

    <label for="global">Note globale *</label>
    <div class="star-rating" id="starRatingInput">
      <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 √©toiles">‚òÖ</label>
      <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 √©toiles">‚òÖ</label>
      <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 √©toiles">‚òÖ</label>
      <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 √©toiles">‚òÖ</label>
      <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 √©toile">‚òÖ</label>
    </div>
    <input type="hidden" id="global" required />


    <label for="synopsis">Synopsis</label>
    <textarea id="synopsis" placeholder="Synopsis du film..."></textarea>

    <label for="commentaire">Commentaire</label>
    <textarea id="commentaire" placeholder="Votre avis sur le film..."></textarea>

    <button type="submit" id="addUpdateBtn">Ajouter üé•</button>
  </form>

  <div class="controls">
    <label for="tri">Trier les films par :</label>
    <select id="tri">
      <option value="dateDesc" selected>Date (du plus r√©cent)</option>
      <option value="dateAsc">Date (du plus ancien)</option>
      <option value="avgDesc">Note moyenne (la plus haute)</option>
      <option value="avgAsc">Note moyenne (la plus basse)</option>
      <option value="directorAsc">R√©alisateur (A-Z)</option>
    </select>
    <input type="text" id="globalSearch" placeholder="Rechercher par titre ou r√©alisateur..." />
  </div>

  <h2>üéûÔ∏è Films vus</h2>
  <div class="film-list" id="filmList"></div>

  <div class="director-ranking-container" id="directorRanking">
    <h2>üèÜ Classement des R√©alisateurs</h2>
    <div class="controls">
        <label for="triDirector">Trier par :</label>
        <select id="triDirector">
            <option value="avgDesc" selected>Moyenne d'√©toiles (d√©croissante)</option>
            <option value="avgAsc">Moyenne d'√©toiles (croissante)</option>
            <option value="filmCountDesc">Nombre de films (d√©croissant)</option>
            <option value="filmCountAsc">Nombre de films (croissant)</option>
        </select>
    </div>
    <ul class="director-ranking-list" id="directorRankingList">
    </ul>
  </div>

  <script>
    const form = document.getElementById('filmForm');
    const filmList = document.getElementById('filmList');
    const triSelect = document.getElementById('tri');
    const triDirectorSelect = document.getElementById('triDirector');
    const addUpdateBtn = document.getElementById('addUpdateBtn');
    const directorList = document.getElementById('directorList');
    const directorRankingList = document.getElementById('directorRankingList');
    const mainTitle = document.getElementById('mainTitle');
    const globalRatingInput = document.getElementById('global');
    const starRatingContainer = document.getElementById('starRatingInput');

    const titleSearchInput = document.getElementById('titleSearch');
    const filmSuggestionsDatalist = document.getElementById('filmSuggestions');
    const titleInput = document.getElementById('title');
    const posterUrlInput = document.getElementById('posterUrl');
    const filmPosterPreview = document.getElementById('filmPosterPreview');
    const directorInput = document.getElementById('director');
    const dateInput = document.getElementById('date');
    const synopsisInput = document.getElementById('synopsis');
    const commentaireInput = document.getElementById('commentaire');
    
    const globalSearchInput = document.getElementById('globalSearch');

    const TMDB_API_KEY = '16da9117701da039a64aa8ea59fb7e11';
    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
    // Utilisons une taille unique pour l'API image pour simplifier, c'est w185 pour les d√©tails qui est la plus pertinente pour la sauvegarde.
    // L'aper√ßu sera simplement redimensionn√© par CSS.
    const TMDB_IMAGE_BASE_URL = 'https://image.themoviedb.org/t/p/w185'; 

    let filmsData = [];
    let debounceTimer;

    function generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    starRatingContainer.addEventListener('change', (e) => {
      if (e.target.name === 'rating') {
        globalRatingInput.value = e.target.value;
      }
    });

    function setStarRating(value) {
      const starId = `star${value}`;
      const starRadio = document.getElementById(starId);
      if (starRadio) {
        starRadio.checked = true;
      }
      globalRatingInput.value = value;
    }

    function getUniqueDirectors(films) {
      const directors = new Set();
      films.forEach(film => {
        if (film.director && film.director.trim() !== '') {
          directors.add(film.director.trim());
        }
      });
      return Array.from(directors).sort();
    }

    function updateDirectorDatalist() {
      const uniqueDirectors = getUniqueDirectors(filmsData);
      directorList.innerHTML = '';

      uniqueDirectors.forEach(director => {
        const option = document.createElement('option');
        option.value = director;
        directorList.appendChild(option);
      });
    }

    function moyenne(film) {
      const value = Number(film.global);
      if (isNaN(value) || value < 1) {
        return 0;
      } else if (value > 5) {
        return 5;
      } else {
        return value;
      }
    }

    function displayStars(rating) {
      const numStars = Math.round(rating);
      return '‚≠ê'.repeat(numStars);
    }

    function displayDirectorRanking() {
      const directorScores = {};

      filmsData.forEach(film => {
        if (film.director && film.director.trim() !== '') {
          const directorName = film.director.trim();
          const filmScore = moyenne(film);

          if (!directorScores[directorName]) {
            directorScores[directorName] = { totalScore: 0, filmCount: 0 };
          }
          directorScores[directorName].totalScore += filmScore;
          directorScores[directorName].filmCount++;
        }
      });

      let rankedDirectors = Object.keys(directorScores)
        .map(director => ({
          name: director,
          averageScore: directorScores[director].totalScore / directorScores[director].filmCount,
          filmCount: directorScores[director].filmCount
        }));

      const triDirector = triDirectorSelect.value;
      rankedDirectors.sort((a, b) => {
        if (triDirector === 'avgDesc') {
          return b.averageScore - a.averageScore;
        } else if (triDirector === 'avgAsc') {
          return a.averageScore - b.averageScore;
        } else if (triDirector === 'filmCountDesc') {
          return b.filmCount - a.filmCount;
        } else if (triDirector === 'filmCountAsc') {
          return a.filmCount - b.filmCount;
        }
        return 0;
      });

      directorRankingList.innerHTML = '';

      if (rankedDirectors.length === 0) {
        directorRankingList.innerHTML = '<li>Aucun r√©alisateur √† classer pour le moment.</li>';
        return;
      }

      rankedDirectors.forEach(director => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${director.name}</span> <span>${displayStars(director.averageScore.toFixed(1))} (${director.averageScore.toFixed(1)}/5) - ${director.filmCount} film(s)</span>`;
        directorRankingList.appendChild(li);
      });
    }

    function chargerFilms(filterQuery = '') {
      const storedFilms = JSON.parse(localStorage.getItem('cinebook_films')) || [];
      filmsData = [];
      let changed = false;

      storedFilms.forEach(film => {
          if (!film.id) {
              film.id = generateUniqueId();
              changed = true;
          }
          filmsData.push(film);
      });

      if (changed) {
          localStorage.setItem('cinebook_films', JSON.stringify(filmsData));
      }

      const tri = triSelect.value;
      let filteredFilms = [...filmsData];

      if (filterQuery.trim() !== '') {
          const lowerCaseQuery = filterQuery.toLowerCase();
          filteredFilms = filteredFilms.filter(film => {
              const titleMatch = film.title && film.title.toLowerCase().includes(lowerCaseQuery);
              const directorMatch = film.director && film.director.toLowerCase().includes(lowerCaseQuery);
              return titleMatch || directorMatch;
          });
      }

      filteredFilms.sort((a, b) => {
        if (tri === 'dateDesc') {
          return new Date(b.date || '0000-01-01') - new Date(a.date || '0000-01-01');
        } else if (tri === 'dateAsc') {
          return new Date(a.date || '0000-01-01') - new Date(b.date || '0000-01-01');
        } else if (tri === 'avgDesc') {
          return moyenne(b) - moyenne(a);
        } else if (tri === 'avgAsc') {
          return moyenne(a) - moyenne(b);
        } else if (tri === 'directorAsc') {
          const directorA = a.director ? a.director.toLowerCase() : '';
          const directorB = b.director ? b.director.toLowerCase() : '';
          return directorA.localeCompare(directorB);
        }
      });

      filmList.innerHTML = '';

      if (filteredFilms.length === 0) {
          filmList.innerHTML = '<p style="text-align: center; color: #9ca3af;">Aucun film trouv√© avec cette recherche.</p>';
      }

      filteredFilms.forEach((film) => {
        const div = document.createElement('div');
        div.className = 'film';
        div.dataset.id = film.id;

        const avgNoteStars = displayStars(moyenne(film));
        const directorDisplay = film.director ? `<div class="film-director">${film.director}</div>` : '';
        
        // L'affiche est maintenant dans les d√©tails, on utilise directement l'URL stock√©e (qui sera en w185)
        const posterHtmlInDetails = film.posterUrl 
            ? `<img src="${film.posterUrl}" alt="Affiche de ${film.title}" class="film-poster" onerror="this.onerror=null;this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; this.style.backgroundColor='#333'; this.style.width='90px'; this.style.height='135px'; this.title='Affiche non disponible';" />`
            : `<div class="film-poster" style="background-color:#333; width:90px; height:135px; display:inline-block; vertical-align:top;" title="Affiche non disponible"></div>`;


        div.innerHTML = `
          <div class="film-header">
            <div class="film-info-main">
              <div class="film-title">${film.title}</div>
              ${directorDisplay}
              <span class="film-date">${formatDate(film.date)}</span>
            </div>
            <span class="film-average">${avgNoteStars}</span>
          </div>
          <div class="film-details">
            ${posterHtmlInDetails}
            <p><strong>R√©alisateur :</strong> ${film.director || 'N/A'}</p>
            <p><strong>Note globale :</strong> ${displayStars(film.global)} (${film.global}/5)</p>
            <p><strong>Synopsis :</strong> ${film.synopsis || '(pas de synopsis)'}</p>
            <p><strong>Commentaire :</strong> ${film.commentaire || '(pas de commentaire)'}</p>
            <button class="btn-action btn-edit" data-id="${film.id}" title="Modifier ce film">‚úèÔ∏è Modifier</button>
            <button class="btn-action btn-delete" data-id="${film.id}" title="Supprimer ce film">üóëÔ∏è Supprimer</button>
          </div>
        `;

        const header = div.querySelector('.film-header');
        const details = div.querySelector('.film-details');
        const btnDelete = div.querySelector('.btn-delete');
        const btnEdit = div.querySelector('.btn-edit');

        btnDelete.addEventListener('click', e => {
          e.stopPropagation();
          const filmIdToDelete = e.target.dataset.id;
          if (confirm(`Supprimer "${filmsData.find(f => f.id === filmIdToDelete)?.title}" ?`)) {
            filmsData = filmsData.filter(f => f.id !== filmIdToDelete);
            localStorage.setItem('cinebook_films', JSON.stringify(filmsData));
            chargerFilms(globalSearchInput.value);
            updateDirectorDatalist();
            displayDirectorRanking();
          }
        });

        btnEdit.addEventListener('click', async (e) => {
            e.stopPropagation();
            const filmIdToEdit = e.target.dataset.id;
            const filmToEdit = filmsData.find(f => f.id === filmIdToEdit);

            if (filmToEdit) {
                titleSearchInput.value = filmToEdit.title; 
                titleInput.value = filmToEdit.title;
                
                directorInput.value = filmToEdit.director || '';
                dateInput.value = filmToEdit.date;
                let displayRating = Number(filmToEdit.global);
                if (isNaN(displayRating) || displayRating < 1) {
                    displayRating = 0;
                } else if (displayRating > 5) {
                    displayRating = 5;
                }
                setStarRating(displayRating);
                synopsisInput.value = filmToEdit.synopsis || '';
                commentaireInput.value = filmToEdit.commentaire;
                posterUrlInput.value = filmToEdit.posterUrl || ''; // L'URL stock√©e est d√©j√† en w185
                
                // Utiliser l'URL stock√©e directement pour la pr√©visualisation dans le formulaire
                if (filmToEdit.posterUrl) {
                    filmPosterPreview.src = filmToEdit.posterUrl; // Utilise directement l'URL w185
                    filmPosterPreview.style.display = 'inline-block';
                } else {
                    posterUrlInput.value = '';
                    filmPosterPreview.style.display = 'none';
                    filmPosterPreview.src = '';
                }

                addUpdateBtn.textContent = 'Modifier ‚úèÔ∏è';
                form.dataset.editingId = filmIdToEdit;

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        header.addEventListener('click', () => {
          const visible = details.style.display === 'block';

          // Fermer tous les autres d√©tails avant d'ouvrir celui-ci
          document.querySelectorAll('.film-details').forEach(d => d.style.display = 'none');

          details.style.display = visible ? 'none' : 'block';
        });

        filmList.appendChild(div);
      });
      updateDirectorDatalist();
      displayDirectorRanking();
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const d = new Date(dateStr);
      const userTimezoneOffset = d.getTimezoneOffset() * 60000;
      const adjustedDate = new Date(d.getTime() + userTimezoneOffset);
      return adjustedDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();

      if (!titleInput.value.trim()) {
        return alert('Le titre du film est requis.');
      }
      if (!globalRatingInput.value || Number(globalRatingInput.value) < 1 || Number(globalRatingInput.value) > 5) {
        return alert('La note globale est obligatoire et doit √™tre comprise entre 1 et 5 √©toiles.');
      }

      const film = {
        title: titleInput.value.trim(),
        director: directorInput.value.trim(),
        date: dateInput.value,
        global: globalRatingInput.value,
        synopsis: synopsisInput.value.trim(),
        commentaire: commentaireInput.value.trim(),
        posterUrl: posterUrlInput.value || '' // posterUrlInput.value contient d√©j√† l'URL w185
      };

      const editingId = form.dataset.editingId;

      if (editingId) {
        const filmIndex = filmsData.findIndex(f => f.id === editingId);
        if (filmIndex !== -1) {
            filmsData[filmIndex] = { ...filmsData[filmIndex], ...film };
        }
        delete form.dataset.editingId;
        addUpdateBtn.textContent = 'Ajouter üé•';
      } else {
        film.id = generateUniqueId();
        filmsData.push(film);
      }

      localStorage.setItem('cinebook_films', JSON.stringify(filmsData));

      form.reset();
      setStarRating(0);
      filmPosterPreview.style.display = 'none'; // Cacher la preview apr√®s soumission
      filmPosterPreview.src = ''; // R√©initialiser la source
      chargerFilms(globalSearchInput.value);
    });

    triSelect.addEventListener('change', () => chargerFilms(globalSearchInput.value));
    triDirectorSelect.addEventListener('change', displayDirectorRanking);

    mainTitle.addEventListener('click', () => {
      document.getElementById('directorRanking').scrollIntoView({
        behavior: 'smooth'
      });
    });

    globalSearchInput.addEventListener('input', (e) => {
        chargerFilms(e.target.value);
    });

    async function searchMovies(query) {
        if (query.length < 3) {
            filmSuggestionsDatalist.innerHTML = '';
            // Si on efface le champ de recherche, on vide aussi les champs li√©s √† l'API
            // Ne pas vider si on est en mode √©dition et que le titre est celui du film √©dit√©
            const currentEditingId = form.dataset.editingId;
            const filmBeingEdited = currentEditingId ? filmsData.find(f => f.id === currentEditingId) : null;

            if (!filmBeingEdited || e.target.value !== filmBeingEdited.title) { 
                titleInput.value = '';
                posterUrlInput.value = '';
                filmPosterPreview.style.display = 'none';
                filmPosterPreview.src = '';
                directorInput.value = '';
                synopsisInput.value = '';
            }
            return;
        }

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            try {
                const response = await fetch(`${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&language=fr-FR`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();
                displayMovieSuggestions(data.results);
            } catch (error) {
                console.error("Erreur lors de la recherche de films:", error);
                filmSuggestionsDatalist.innerHTML = '';
            }
        }, 300);
    }

    function displayMovieSuggestions(movies) {
        filmSuggestionsDatalist.innerHTML = '';
        movies.forEach(movie => {
            const option = document.createElement('option');
            option.value = movie.title;
            option.dataset.id = movie.id; 
            option.dataset.posterPath = movie.poster_path;
            option.dataset.overview = movie.overview || '';
            filmSuggestionsDatalist.appendChild(option);
        });
    }

    async function getMovieDetails(movieId) {
        try {
            const response = await fetch(`${TMDB_BASE_URL}/movie/${movieId}?api_key=${TMDB_API_KEY}&append_to_response=credits&language=fr-FR`);
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error(`Erreur lors de la r√©cup√©ration des d√©tails du film ${movieId}:`, error);
            return null;
        }
    }

    titleSearchInput.addEventListener('change', async (e) => {
        const selectedOption = Array.from(filmSuggestionsDatalist.options).find(
            option => option.value === e.target.value
        );

        if (selectedOption) {
            const movieId = selectedOption.dataset.id;
            titleInput.value = selectedOption.value;
            
            const posterPath = selectedOption.dataset.posterPath;
            if (posterPath) {
                // Utilise la TMDB_IMAGE_BASE_URL (w185) pour la pr√©visualisation et le stockage
                const fullPosterUrl = `${TMDB_IMAGE_BASE_URL}${posterPath}`; 

                posterUrlInput.value = fullPosterUrl; // Stocke l'URL w185
                filmPosterPreview.src = fullPosterUrl; // Affiche la preview w185
                filmPosterPreview.style.display = 'inline-block';
            } else {
                // Si pas de poster_path, on r√©initialise
                posterUrlInput.value = '';
                filmPosterPreview.style.display = 'none';
                filmPosterPreview.src = '';
            }
            
            synopsisInput.value = selectedOption.dataset.overview || '';

            if (movieId) {
                const movieDetails = await getMovieDetails(movieId);
                if (movieDetails && movieDetails.credits && movieDetails.credits.crew) {
                    const director = movieDetails.credits.crew.find(
                        (member) => member.job === 'Director'
                    );
                    if (director) {
                        directorInput.value = director.name;
                    } else {
                        directorInput.value = '';
                    }
                } else {
                    directorInput.value = '';
                }
            }
        } else {
            // Si le texte saisi ne correspond √† aucune suggestion s√©lectionn√©e (ou est effac√©)
            // On r√©initialise les champs li√©s √† l'API, SAUF si on est en mode √©dition
            const currentEditingId = form.dataset.editingId;
            const filmBeingEdited = currentEditingId ? filmsData.find(f => f.id === currentEditingId) : null;
            
            if (!filmBeingEdited || e.target.value !== filmBeingEdited.title) {
                posterUrlInput.value = '';
                filmPosterPreview.style.display = 'none';
                filmPosterPreview.src = '';
                directorInput.value = '';
                synopsisInput.value = '';
                // titleInput.value est d√©j√† mis √† jour par l'√©v√©nement 'input'
            }
        }
    });

    window.addEventListener('load', () => {
        chargerFilms();
        updateDirectorDatalist();
        displayDirectorRanking();
        setStarRating(0);
    });
  </script>
</body>
</html>